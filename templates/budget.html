<html>
<head>

<style>
#progress-div {
    float: left;
    width: 48%;
}

#visualization-div {
    float: right;
    width: 48%;
    position: relative;
}

#purchases-div {
    float: left;
    width: 48%;
}

#purchases-div > div {
    height: 200px;
    overflow: auto;
}

#purchases-div table {
    border-collapse:collapse;
}

#progress-div span {
    border-style: none !important;
    font-weight: bold;
}

</style>

<script type="text/javascript" src="/dough/static/flot/jquery.flot.min.js"/>

<script>

var refreshBudget = function(progress, budget) {
    var percent = 100 * progress / budget;
    $("#progress-bar").progressbar({value:percent}); 

    var remaining = Math.round((budget-progress)*100)/100;
    $("#budget-progress-spent").html("$"+progress);
    $("#budget-progress-left").html("$"+remaining);

    $("#budget-span").html("$"+budget);
    $("#spent-span").html("$"+progress);
    $("#remaining-span").html("$"+remaining);
}

var refreshPlot = function(monthly_budget) {
    $.plot($("#flot-placeholder"), [
        {
            data: {{ plot_data }},
            bars: {show: true}
        },
        {
            data: [[1,monthly_budget],[13,monthly_budget]]
        }
    ], {
        xaxis: {
            ticks: {{ plot_xticks|safe }}
        },
        yaxis: {
            min: 0
        } 
    });
}

var submitBudgetChange = function() {
    var val = $("#change-budget-input").val();
    if (!(/^\d*$/.test(val))) {
        // If not an integer, don't submit.
        return true;
    }
    $.ajax({
        type:"POST",
        url:"/dough/ajax/set_budget/",
        data:{budget:val},
        complete:function(res,status){
            if (status == "success") {
                refreshBudget({{ spent_this_month }},val);
                refreshPlot(val);
            } else {
                alert(res.responseText);
                alert("Failed to change budget. Please reload page.");
            }
        }
    });
    return false;
}

$(function(){
    refreshBudget({{ spent_this_month }},{{ monthly_budget }});
    refreshPlot({{monthly_budget}});

    $("#change-budget-submit").button()
        .click(submitBudgetChange);
});


</script>
</head>
<body>

<div id="progress-div">
    <h3>Summary</h3>
    <p><div id="progress-bar" style="position:relative">
    <span id="budget-progress-spent" class="ui-widget-header" style="position:absolute;top:6px;left:10px">$41.27</span>
    <span id="budget-progress-left" style="position:absolute;top:6px;right:10px">$258.73</span>
    </div></p>

    <p>You've spent <span id="spent-span">${{ spent_this_month }}</span> of your <span id="budget-span">${{ monthly_budget }}</span> budget.</p>
    <p>You have <span id="remaining-span"></span> left to spend this month.</p>

<form>
<input id="change-budget-input" type="number" style="width:80px;" value="{{ monthly_budget }}"/>
<small><input type="submit" id="change-budget-submit" value="Change monthly budget"/></small>
</form>
<br />
</div>

<div id="visualization-div">
    <h3>Spending over the last year</h3>
    <div id="flot-placeholder" style="height:300px"></div>
</div>

<div id="purchases-div">
    <h3>Latest purchases</h3>
    <div>
    <table style="width=100%">
    {% for purchase in purchases %}
    <tr class="ui-state-default">
        <td>${{ purchase.amount }}</td>
        <td width="100%" style="text-align:right;">{{ purchase.date }}</td>
    </tr>
    {% endfor %}
    </table>
    </div>
</div>

</body>
</html>
